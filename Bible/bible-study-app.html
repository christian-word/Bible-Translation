<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Изучение Библии с ИИ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        .verse-highlight { background-color: #fef3c7; }
        /* Кастомный скроллбар для чата */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="flex flex-col h-screen">
        <header class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                <h1 class="text-xl font-bold text-gray-900 hidden md:block">Изучение Писания</h1>
            </div>
            
            <div class="flex items-center gap-2">
                <select id="modelSelect" class="p-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none w-40">
                    <option value="" disabled selected>Загрузка моделей...</option>
                </select>
                
                <label for="fileInput" class="p-2 hover:bg-gray-100 rounded-lg cursor-pointer" title="Загрузить переводы вручную">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                </label>
                <input type="file" id="fileInput" multiple accept=".json" class="hidden">
                
                <button id="testApiBtn" class="p-2 hover:bg-gray-100 rounded-lg" title="Тест API">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
                
                <button id="aiToggle" class="p-2 rounded-lg hover:bg-gray-100" title="Открыть ИИ-чат">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </button>
                <button id="menuBtn" class="md:hidden p-2 hover:bg-gray-100 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside id="sidebar" class="hidden md:flex md:w-80 border-r border-gray-200 flex-col bg-white">
                <div class="p-4 border-b border-gray-200">
                    <div class="mb-4 relative">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input id="searchInput" type="text" placeholder="Поиск по тексту..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-700 block mb-2">Переводы:</label>
                        <div id="translationsList" class="space-y-1"></div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto scrollbar-thin p-4">
                    <div id="searchResults" class="hidden space-y-2 mb-4"></div>
                    <div id="navigation">
                        <div class="mb-4">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Книга:</label>
                            <select id="bookSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Глава:</label>
                            <div id="chapterGrid" class="grid grid-cols-5 gap-1"></div>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="flex-1 overflow-y-auto scrollbar-thin p-6">
                <div id="loadingScreen" class="max-w-4xl mx-auto text-center py-20">
                    <svg class="w-16 h-16 mx-auto mb-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Загрузка данных...</h2>
                    <p class="text-gray-600 mb-6" id="loadingMessage">Попытка автоматической загрузки файлов переводов...</p>
                    <p class="text-sm text-gray-500">Если автозагрузка не удалась (файлы не найдены): нажмите на иконку загрузки сверху и выберите JSON файлы.</p>
                </div>
                <div id="contentArea" class="max-w-4xl mx-auto hidden">
                    <h2 id="chapterTitle" class="text-2xl font-bold text-gray-900 mb-6"></h2>
                    <div id="versesContainer" class="space-y-6"></div>
                </div>
            </main>

            <aside id="aiPanel" class="hidden md:w-96 border-l border-gray-200 flex-col bg-white">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="font-semibold text-gray-900">ИИ-помощник (<span id="currentModelDisplay">...</span>)</h3>
                    <button id="aiClose" class="md:hidden p-2 hover:bg-gray-100 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="aiMessages" class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-4">
                    <div class="text-center text-gray-500 mt-8">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p class="text-sm">Задайте вопрос о тексте</p>
                        <p class="text-xs mt-2">Например: "Сравни переводы этого стиха"</p>
                    </div>
                </div>
                
                <div class="p-4 border-t border-b border-gray-200 bg-gray-50 flex flex-wrap gap-2 justify-center">
                    <button onclick="sendSummary()" class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200">
                        💡 Сводка Главы
                    </button>
                    <button onclick="sendCrossReferences()" class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-full hover:bg-purple-200">
                        🔗 Связанные Стихи
                    </button>
                </div>

                <div class="p-4 border-t border-gray-200">
                    <div class="flex gap-2">
                        <input id="aiInput" type="text" placeholder="Задайте вопрос..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <button id="aiSend" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">→</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

 <script>
        const TRANSLATIONS = {
            'HOM_Хоменко': 'Хоменко',
            'UBIO_Огієнко': 'Огієнко',
            'UTT_Турконяк': 'Турконяк',
            'NRT_Новый': 'Новый русский',
            'SYNOD_Синодальный': 'Синодальный'
        };

        const DEFAULT_TRANSLATION_FILES = [
            'HOM_Хоменко.json',
            'UBIO_Огієнко.json',
            'UTT_Турконяк.json',
            'NRT_Новый.json',
            'SYNOD_Синодальный.json' 
        ];

        const state = {
            bibleData: {},
            translations: [],
            activeTranslations: [],
            selectedBook: '',
            selectedChapter: '',
            searchQuery: '',
            aiMessages: [],
            isLoading: false,
            models: [],
            selectedModel: '' // ДОБАВЛЕНО ДЛЯ СОХРАНЕНИЯ СОСТОЯНИЯ
        };

        // ВАШ КЛЮЧ GROQ API
        // Замените этот ключ на свой реальный ключ Groq API
        const GROQ_API_KEY = "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"; 
        
        const MODEL_SELECT = document.getElementById('modelSelect');
        const CURRENT_MODEL_DISPLAY = document.getElementById('currentModelDisplay');
        const LOADING_SCREEN = document.getElementById('loadingScreen');
        const CONTENT_AREA = document.getElementById('contentArea');
        const SIDEBAR = document.getElementById('sidebar');
        
        // === ЛОГИКА СОХРАНЕНИЯ/ЗАГРУЗКИ СОСТОЯНИЯ (ЭТАП 1) ===

        function saveState() {
            try {
                const serializedState = JSON.stringify({
                    activeTranslations: state.activeTranslations,
                    selectedBook: state.selectedBook,
                    selectedChapter: state.selectedChapter,
                    selectedModel: state.selectedModel || MODEL_SELECT.value
                });
                localStorage.setItem('bibleStudyState', serializedState);
            } catch (e) {
                console.error("Ошибка сохранения состояния:", e);
            }
        }

        function loadState() {
            try {
                const serializedState = localStorage.getItem('bibleStudyState');
                if (serializedState === null) {
                    return undefined;
                }
                const loaded = JSON.parse(serializedState);
                
                // Применяем загруженные параметры, если они существуют
                if (loaded.activeTranslations && loaded.activeTranslations.length > 0) {
                    state.activeTranslations = loaded.activeTranslations;
                }
                if (loaded.selectedBook) {
                    state.selectedBook = loaded.selectedBook;
                }
                if (loaded.selectedChapter) {
                    state.selectedChapter = loaded.selectedChapter;
                }
                if (loaded.selectedModel) {
                    state.selectedModel = loaded.selectedModel;
                }
                
            } catch (e) {
                console.error("Ошибка загрузки состояния:", e);
                return undefined;
            }
        }


        // === Инициализация UI после загрузки данных ===
        function startAppRendering() {
            if (state.translations.length > 0) {
                loadState(); // <-- ЗАГРУЖАЕМ СОСТОЯНИЕ

                // Устанавливаем значения по умолчанию, ТОЛЬКО если они не были загружены или недействительны
                if (state.activeTranslations.length === 0 || !state.activeTranslations.every(t => state.translations.includes(t))) {
                    state.activeTranslations = [state.translations[0]];
                }
                
                const allBooks = Object.keys(state.bibleData[state.translations[0]]);
                if (!state.selectedBook || !allBooks.includes(state.selectedBook)) {
                    state.selectedBook = allBooks[0];
                }
                
                // Проверяем, существует ли глава в выбранной книге
                if (!state.selectedChapter || !state.bibleData[state.translations[0]][state.selectedBook]?.[state.selectedChapter]) {
                    state.selectedChapter = '1';
                }
                
                LOADING_SCREEN.classList.add('hidden');
                CONTENT_AREA.classList.remove('hidden');
                SIDEBAR.classList.remove('hidden');
                SIDEBAR.classList.add('flex');
                
                renderTranslations();
                renderBooks();
                renderChapters();
                renderVerses();
            } else {
                 document.getElementById('loadingMessage').textContent = 'Файлы не найдены. Выберите их вручную.';
            }
        }
        
        // === Логика автозагрузки переводов ===
        async function autoLoadTranslations() {
            let successfulLoads = 0;
            const loadPromises = DEFAULT_TRANSLATION_FILES.map(async (fileName) => {
                try {
                    document.getElementById('loadingMessage').textContent = `Попытка загрузки: ${fileName}...`;
                    const response = await fetch(fileName);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const text = await response.text();
                    const data = JSON.parse(text);
                    const key = fileName.replace('.json', '');
                    state.bibleData[key] = data;
                    state.translations.push(key);
                    successfulLoads++;

                } catch (error) {
                    // console.warn(`Не удалось загрузить ${fileName} автоматически:`, error.message);
                }
            });

            await Promise.all(loadPromises);
            document.getElementById('loadingMessage').textContent = successfulLoads > 0
                ? `Успешно загружено ${successfulLoads} перевод(а/ов).`
                : 'Автоматическая загрузка не удалась. Пожалуйста, выберите файлы вручную.';
                
            startAppRendering();
        }

        // === Логика ручной загрузки переводов ===
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            LOADING_SCREEN.classList.remove('hidden');
            document.getElementById('loadingMessage').textContent = 'Загрузка выбранных файлов...';

            for (const file of files) {
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    const key = file.name.replace('.json', '');
                    state.bibleData[key] = data;
                    state.translations.push(key);
                } catch (error) {
                    console.error(`Error loading ${file.name}:`, error);
                    alert(`Ошибка загрузки файла ${file.name}`);
                }
            }
            state.translations = [...new Set(state.translations)];
            startAppRendering();
        });


        // === Управление моделями ===
        async function loadModels() {
            MODEL_SELECT.innerHTML = '<option value="" disabled selected>Загрузка моделей...</option>';
            MODEL_SELECT.disabled = true;

            try {
                const response = await fetch('https://api.groq.com/openai/v1/models', {
                    headers: { 'Authorization': `Bearer ${GROQ_API_KEY}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP ${response.status}: ${errorData.error?.message || 'Неизвестная ошибка'}`);
                }

                const data = await response.json();
                
                state.models = (data.data || []).filter(m => 
                    m.id.includes('llama') || m.id.includes('mixtral') || m.id.includes('gemma')
                );

                MODEL_SELECT.innerHTML = state.models.map(m => 
                    `<option value="${m.id}">${m.id}</option>`
                ).join('');
                
                selectFirstModel();
                MODEL_SELECT.disabled = false;
                CURRENT_MODEL_DISPLAY.textContent = MODEL_SELECT.value;

            } catch (e) {
                console.error("Ошибка загрузки моделей:", e);
                MODEL_SELECT.innerHTML = `<option value="" disabled selected>Ошибка загрузки</option>`;
                MODEL_SELECT.disabled = true;
                CURRENT_MODEL_DISPLAY.textContent = 'Ошибка';
            }
        }
        
        function selectFirstModel() {
             if (state.models.length > 0) {
                 let selectedId = state.selectedModel; // Используем загруженную модель
                 
                 if (!selectedId || !state.models.find(m => m.id === selectedId)) {
                     // Если загруженная модель недействительна, выбираем предпочтительную по умолчанию
                     const preferredModel = state.models.find(m => m.id.includes('70b') || m.id.includes('mixtral'));
                     selectedId = preferredModel ? preferredModel.id : state.models[0].id;
                 }
                 
                 MODEL_SELECT.value = selectedId;
                 state.selectedModel = selectedId; // Обновляем состояние после выбора
                 saveState(); // <-- СОХРАНЯЕМ ВЫБОР МОДЕЛИ
             } else {
                 MODEL_SELECT.innerHTML = `<option value="" disabled selected>Нет доступных моделей</option>`;
             }
        }
        
        MODEL_SELECT.addEventListener('change', () => {
             state.selectedModel = MODEL_SELECT.value; // Обновляем состояние
             CURRENT_MODEL_DISPLAY.textContent = state.selectedModel;
             saveState(); // <-- СОХРАНЯЕМ ВЫБОР МОДЕЛИ
        });
        
        // === НОВЫЕ ФУНКЦИИ: Быстрые команды ИИ ===

        function sendAIShortcut(userPrompt) {
            document.getElementById('aiInput').value = userPrompt;
            sendToAI();
        }

        function sendSummary() {
            sendAIShortcut('Сделай краткую сводку этой главы и выдели 3 ключевые идеи. Опирайся только на предоставленный текст.');
        }

        function sendCrossReferences() {
            sendAIShortcut('Найди 5 наиболее релевантных перекрестных ссылок (Книга Глава:Стих) в других частях Писания, которые поясняют тему этой главы. Укажи только Книга Глава:Стих, без пояснений.');
        }
        
        // === ИНТЕЛЛЕКТУАЛЬНЫЙ ПОИСК КНИГИ (ФИНАЛЬНОЕ УЛУЧШЕНИЕ ДЛЯ ПАДЕЖЕЙ) ===

        // 1. Утилита для базовой очистки: нижний регистр и удаление пунктуации, но СОХРАНЕНИЕ ПРОБЕЛОВ.
        function baseCleanName(name) {
            // Удаляем только знаки препинания и приводим к нижнему регистру
            return name.toLowerCase().trim().replace(/['"«»\.,;:\-]/g, '').replace(/[^а-яa-z0-9\s]/g, '');
        }

        // 2. Утилита для агрессивной очистки: удаляет общие префиксы, затем все пробелы.
        function aggressiveCleanName(name) {
            let cleaned = baseCleanName(name);
            
            // Удаление префиксов (обратите внимание на \s+ для учета пробелов)
            cleaned = cleaned.replace(/^(книга\s+пророка\s+|книга\s+|пророка\s+|послание\s+к\s+|евангелие\s+от\s+|первое\s+|второе\s+|третье\s+|четвертое\s+|от\s+|к\s+|святого\s+|апостола\s+)/, '');
            
            // Удаление всех оставшихся пробелов для создания чистой строки
            cleaned = cleaned.replace(/\s+/g, '');
            
            // --- СПЕЦИАЛЬНАЯ ОБРАБОТКА (УБИРАЕТ СКЛОНЕНИЕ/СОКРАЩЕНИЕ) ---
            
            // Псалом -> Псалтирь
            if (cleaned.startsWith('псалом')) cleaned = 'псалтирь';

            // Исаия/Исаии/Ис.
            if (cleaned.includes('исаи')) cleaned = 'исаия';
            
            // Иезекииль/Иез.
            if (cleaned.includes('иезек')) cleaned = 'иезекииль';
            
            // Иеремия/Иеремии/Иер. <--- ДОБАВЛЕН НОВЫЙ ФИКС ДЛЯ ИЕРЕМИИ
            if (cleaned.includes('иерем')) cleaned = 'иеремия'; 
            
            // Даниил/Дан.
            if (cleaned.includes('дании')) cleaned = 'даниил';

            // Евреям -> Послание к евреям
            if (cleaned.includes('евреям')) cleaned = 'посланиекевреям';
            
            return cleaned;
        }

        // 3. Основная функция поиска ключа книги
        function findBookKey(rawName) {
            if (state.translations.length === 0 || !state.bibleData[state.translations[0]]) return null;

            const dataKeys = Object.keys(state.bibleData[state.translations[0]]);
            const aggressiveInput = aggressiveCleanName(rawName);
            
            for (const key of dataKeys) {
                const aggressiveKey = aggressiveCleanName(key);

                // 1. Точное совпадение очищенных агрессивных форм
                if (aggressiveKey === aggressiveInput) {
                    return key; // Возвращаем оригинальный ключ из JSON
                }
                
                // 2. Частичное совпадение (для случаев, когда ИИ выдает уникальное сокращение)
                if (aggressiveKey.includes(aggressiveInput) && aggressiveInput.length > 3) {
                     return key;
                }
            }
            
            return null; // Книга не найдена
        }


        // === ДЕЛАЕТ ССЫЛКИ КЛИКАБЕЛЬНЫМИ ===
        function makeReferencesClickable(text) {
            // Регулярное выражение для поиска шаблонов "Книга Глава:Стих" или "Книга Глава"
            const referenceRegex = /([\p{L}\p{M}\s\.\-]+)\s(\d{1,3})(:\d{1,3}(-\d{1,3})?)?/gu;

            return text.replace(referenceRegex, (match, book, chapter, versePart) => {
                // Извлекаем только первый стих, чтобы сфокусироваться при переходе
                const verse = versePart ? versePart.substring(1).split('-')[0] : '1'; 
                
                // Очищаем имя книги от лишних символов (например, конечной точки)
                const cleanedBook = book.trim().replace(/\.$/, ''); 

                // Возвращаем HTML-ссылку, которая вызывает функцию navigateTo
                return `<a href="#" onclick="navigateTo('${cleanedBook}', '${chapter}', '${verse}'); event.preventDefault();" class="text-blue-600 underline font-medium hover:text-blue-800 transition-colors">${match}</a>`;
            });
        }
        
        // === Существующие функции рендеринга и логики ===
        
        function renderTranslations() {
            const list = document.getElementById('translationsList');
            list.innerHTML = state.translations.map(trans => `
                <label class="flex items-center gap-2 text-sm cursor-pointer">
                    <input type="checkbox" ${state.activeTranslations.includes(trans) ? 'checked' : ''} 
                           onchange="toggleTranslation('${trans}')" class="rounded text-blue-600">
                    <span>${TRANSLATIONS[trans]}</span>
                </label>
            `).join('');
        }

        function toggleTranslation(trans) {
            if (state.activeTranslations.includes(trans)) {
                if (state.activeTranslations.length > 1) {
                    state.activeTranslations = state.activeTranslations.filter(t => t !== trans);
                }
            } else {
                state.activeTranslations.push(trans);
            }
            renderVerses();
            saveState(); // <-- ДОБАВЛЕНО СОХРАНЕНИЕ
        }

        function renderBooks() {
            const select = document.getElementById('bookSelect');
            if (state.translations.length === 0 || !state.bibleData[state.translations[0]]) return;
            
            const books = Object.keys(state.bibleData[state.translations[0]]);
            select.innerHTML = books.map(book => 
                `<option value="${book}" ${book === state.selectedBook ? 'selected' : ''}>${book}</option>`
            ).join('');
            select.onchange = (e) => {
                state.selectedBook = e.target.value;
                state.selectedChapter = '1';
                renderChapters();
                renderVerses();
                saveState(); // <-- ДОБАВЛЕНО СОХРАНЕНИЕ
            };
        }

        function renderChapters() {
            const grid = document.getElementById('chapterGrid');
             if (state.translations.length === 0 || !state.bibleData[state.translations[0]]?.[state.selectedBook]) return;
            
            const chapters = Object.keys(state.bibleData[state.translations[0]][state.selectedBook]);
            grid.innerHTML = chapters.map(ch => `
                <button onclick="selectChapter('${ch}')" 
                        class="p-2 rounded text-sm ${ch === state.selectedChapter ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}">
                    ${ch}
                </button>
            `).join('');
        }

        function selectChapter(chapter) {
            state.selectedChapter = chapter;
            renderChapters();
            renderVerses();
            saveState(); // <-- ДОБАВЛЕНО СОХРАНЕНИЕ
        }

        function renderVerses() {
            const container = document.getElementById('versesContainer');
            const title = document.getElementById('chapterTitle');
            title.textContent = `${state.selectedBook} ${state.selectedChapter}`;

            const verses = {};
            state.activeTranslations.forEach(trans => {
                const chapter = state.bibleData[trans]?.[state.selectedBook]?.[state.selectedChapter];
                if (chapter) {
                    Object.keys(chapter).forEach(verseNum => {
                        if (!verses[verseNum]) verses[verseNum] = {};
                        verses[verseNum][trans] = chapter[verseNum];
                    });
                }
            });

            container.innerHTML = Object.keys(verses).map(verseNum => `
                <div id="verse-${verseNum}" class="bg-white rounded-lg p-4 shadow-sm">
                    <div class="flex items-start gap-3">
                        <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full text-sm font-semibold">
                            ${verseNum}
                        </span>
                        <div class="flex-1 space-y-3">
                            ${state.activeTranslations.map(trans => `
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">${TRANSLATIONS[trans]}</div>
                                    <p class="text-gray-800 leading-relaxed">${verses[verseNum][trans]}</p>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="copyVerse(${verseNum})" class="flex-shrink-0 p-2 hover:bg-gray-100 rounded-lg" title="Копировать">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function copyVerse(verseNum) {
            const verses = {};
            state.activeTranslations.forEach(trans => {
                const text = state.bibleData[trans]?.[state.selectedBook]?.[state.selectedChapter]?.[verseNum];
                if (text) verses[trans] = text;
            });
            
            const text = Object.keys(verses).map(trans => 
                `${TRANSLATIONS[trans]}: ${verses[trans]}`
            ).join('\n');
            
            navigator.clipboard.writeText(`${state.selectedBook} ${state.selectedChapter}:${verseNum}\n${text}`);
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        function performSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!query) {
                document.getElementById('searchResults').classList.add('hidden');
                document.getElementById('navigation').classList.remove('hidden');
                return;
            }

            const results = [];
            state.activeTranslations.forEach(trans => {
                Object.keys(state.bibleData[trans]).forEach(book => {
                    Object.keys(state.bibleData[trans][book]).forEach(chapter => {
                        Object.keys(state.bibleData[trans][book][chapter]).forEach(verse => {
                            const text = state.bibleData[trans][book][chapter][verse];
                            if (text.toLowerCase().includes(query)) {
                                results.push({ trans, book, chapter, verse, text });
                            }
                        });
                    });
                });
            });

            const container = document.getElementById('searchResults');
            if (results.length > 0) {
                container.classList.remove('hidden');
                document.getElementById('navigation').classList.add('hidden');
                container.innerHTML = `
                    <h3 class="font-semibold text-gray-900 mb-3">Результаты (${results.length})</h3>
                    ${results.slice(0, 50).map(r => `
                        <button onclick="navigateTo('${r.book}', '${r.chapter}', '${r.verse}')" 
                                class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg">
                            <div class="text-xs font-medium text-blue-600 mb-1">
                                ${r.book} ${r.chapter}:${r.verse}
                            </div>
                            <div class="text-sm text-gray-700 line-clamp-2">${r.text}</div>
                        </button>
                    `).join('')}
                `;
            }
        }

        // ОБНОВЛЕНО: Использует findBookKey для надежной навигации
        function navigateTo(rawBook, chapter, verse) {
            const actualBookKey = findBookKey(rawBook);

            if (!actualBookKey) {
                // Если не нашли, показываем сообщение об ошибке
                alert(`Не удалось найти книгу с названием "${rawBook}" в загруженных переводах. Убедитесь, что файлы загружены и название книги указано верно.`);
                return;
            }

            // Устанавливаем корректное название книги и главу
            state.selectedBook = actualBookKey;
            state.selectedChapter = chapter;
            // Сбрасываем поиск
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('navigation').classList.remove('hidden');
            
            // Сохраняем новое состояние
            saveState(); // <-- ДОБАВЛЕНО СОХРАНЕНИЕ
            
            renderBooks();
            renderChapters();
            renderVerses();
            
            // Задержка, чтобы гарантировать, что контент прогрузился, прежде чем прокручивать
            setTimeout(() => {
                // Плавная прокрутка к стиху
                document.getElementById(`verse-${verse}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // AI Functions
        document.getElementById('aiToggle').addEventListener('click', () => {
            const panel = document.getElementById('aiPanel');
            panel.classList.toggle('hidden');
            panel.classList.toggle('flex');
        });
        
        document.getElementById('aiClose').addEventListener('click', () => {
            const panel = document.getElementById('aiPanel');
            panel.classList.add('hidden');
            panel.classList.remove('flex');
        });

        document.getElementById('aiInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendToAI();
        });

        document.getElementById('aiSend').addEventListener('click', sendToAI);

        async function sendToAI() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            const selectedModel = MODEL_SELECT.value; 
            
            if (!message || state.isLoading || !selectedModel || MODEL_SELECT.disabled) {
                if (!selectedModel || MODEL_SELECT.disabled) alert("Пожалуйста, дождитесь загрузки моделей.");
                return;
            }

            state.isLoading = true;
            input.value = '';

            state.aiMessages.push({ role: 'user', content: message });
            renderAiMessages();

            const context = getContext();
            const systemPrompt = `Ты помощник для изучения Библии. Твоя задача - помогать понять текст, но НЕ давать окончательные толкования.
            
            ВАЖНО: Если пользователь запросил перекрестные ссылки ('Найди 5 наиболее релевантных перекрестных ссылок...'), ТОЛЬКО выведи их списком Книга Глава:Стих, без лишних слов.

Доступные переводы: ${state.activeTranslations.map(t => TRANSLATIONS[t]).join(', ')}

Текущий контекст изучения:
${context}

Правила:
- Будь кратким и по делу
- Сравнивай переводы, если это полезно
- Объясняй контекст (исторический, культурный)
- Задавай вопросы для размышления
- Не навязывай доктрину
- Направляй к тексту, а не от него
- Отвечай на русском или украинском (зависит от языка вопроса)`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: selectedModel, 
                        messages: [
                            { role: "system", content: systemPrompt },
                            ...state.aiMessages.slice(-10).map(msg => ({ role: msg.role, content: msg.content }))
                        ],
                        temperature: 0.7,
                        max_tokens: 1500
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    console.error("API Error:", data);
                    state.aiMessages.push({ role: 'assistant', content: `Ошибка API: ${data.error?.message || 'Неизвестная ошибка'}.` });
                    renderAiMessages();
                    return;
                }
                
                const aiResponse = data.choices?.[0]?.message?.content || "Извините, произошла ошибка.";
                
                state.aiMessages.push({ role: 'assistant', content: aiResponse });
                renderAiMessages();
            } catch (error) {
                console.error("AI Error:", error);
                state.aiMessages.push({ role: 'assistant', content: `Ошибка при обращении к ИИ: ${error.message}` });
                renderAiMessages();
            } finally {
                state.isLoading = false;
            }
        }

        function getContext() {
            let context = `Книга: ${state.selectedBook}, Глава: ${state.selectedChapter}\n\n`;
            
            state.activeTranslations.forEach(trans => {
                context += `\n=== ${TRANSLATIONS[trans]} ===\n`;
                const chapter = state.bibleData[trans]?.[state.selectedBook]?.[state.selectedChapter];
                if (chapter) {
                    Object.keys(chapter).forEach(v => {
                        context += `${v}. ${chapter[v]}\n`;
                    });
                }
            });
            
            return context;
        }

        // Рендеринг сообщений использует makeReferencesClickable
        function renderAiMessages() {
            const container = document.getElementById('aiMessages');
            if (state.aiMessages.length === 0) {
                 container.innerHTML = `<div class="text-center text-gray-500 mt-8">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p class="text-sm">Задайте вопрос о тексте</p>
                        <p class="text-xs mt-2">Например: "Сравни переводы этого стиха"</p>
                    </div>`;
            } else {
                container.innerHTML = state.aiMessages.map(msg => {
                    // Применяем функцию только к ответам ассистента
                    const content = msg.role === 'assistant' 
                        ? makeReferencesClickable(msg.content)
                        : msg.content;
                    
                    return `
                        <div class="${msg.role === 'user' ? 'text-right' : 'text-left'}">
                            <div class="inline-block max-w-[85%] p-3 rounded-lg ${
                                msg.role === 'user' 
                                    ? 'bg-blue-600 text-white' 
                                    : 'bg-gray-100 text-gray-800'
                            }">
                                <p class="text-sm whitespace-pre-wrap">${content}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (state.isLoading) {
                    container.innerHTML += `
                        <div class="flex items-center gap-2 text-gray-500">
                            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-sm">Думаю...</span>
                        </div>
                    `;
                }
            }
            container.scrollTop = container.scrollHeight;
        }

        // Mobile menu
        document.getElementById('menuBtn').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('flex');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('inset-0');
            sidebar.classList.toggle('z-10');
        });

        // Test API button
        document.getElementById('testApiBtn').addEventListener('click', async () => {
            console.log('Testing API...');
            await loadModels(); 
            if (state.models.length > 0) {
                alert('API работает! Доступные модели загружены, первая выбрана для использования.');
            }
        });

        // Запуск при загрузке страницы: загружаем модели и пытаемся загрузить переводы
        window.addEventListener('load', () => {
            loadModels();
            autoLoadTranslations();
        });
    </script>
</body>
</html>